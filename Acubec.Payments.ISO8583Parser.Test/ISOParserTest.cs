using Acubec.Payments.ISO8583Parser.Definitions;
using Acubec.Payments.ISO8583Parser.Helpers;
using Microsoft.Extensions.DependencyInjection;
using Moq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using Xunit;

namespace Acubec.Payments.ISO8583Parser.Test;

public class ISOParserTest: IClassFixture<ISO8583ParserTestFixture>
{
    readonly IServiceProvider _serviceProvider;

    public ISOParserTest(ISO8583ParserTestFixture fixture)
	{
        _serviceProvider = fixture.ServiceProvider;
    }


    [Fact]
    public void Parse_ShouldParsenIsoMessage()
    {
        // Arrange
        var jsonConfiguration = File.ReadAllText(@"D:\Ajay\Projects\Self\Git\Acubec.Payments.ISO8583Parser\Acubec.Payments.ISO8583Parser.Test\RupaySchema.json");
        JsonSerializerOptions options = new();
        options.PropertyNameCaseInsensitive = true;
        var configuration = System.Text.Json.JsonSerializer.Deserialize<SchemaConfiguration>(jsonConfiguration, options);
        
        var mockServiceProvider = new Mock<IServiceProvider>();
        


        var parser = new ISO8583MessageParser(_serviceProvider);
        var strMessageBytes = "30323030F23B66810AE08208000000000100000031363636373738383030303030303030303431323334353630303030303036303030303031323231313432373033303030303031303932373033313232313132323131323231353939393335363930313030313030303637323030303133333535303930303030303130305445535431323334544553543132333435363738393031525550415920544553542053494D554C41544F522020204D554D424149202020202020204D48494E333536313633394630323030303946303330303039463236303030303832303034373830303946333630303035463334303030394632373030323830394633343030363146303030323946313030313630313035413030303033303030303030394633333030364530453038303946314130303039463335303032323230393530313030303030303438303030354632413030303039413030303039433030323132394633373030303034313237354134363356523331313030303435323031324156454E55452053555045524D41524420494E44303739303038303031353030393035303132333435363738393031323334353637383930313233343536373839304173646667686A6B6C706F69757974726577713130313330303236343031343030323235";
        var messageBytes = ByteHelper.GetBytesFromHexString(strMessageBytes);

        // Act
        var result = parser.Parse(configuration, messageBytes, _serviceProvider);
        
        // Assert
        Assert.NotNull(result);
        // Add more assertions as needed
    }

    [Fact]
    public void Parse_ShouldConvertToStringIsoMessage()
    {
        // Arrange
        var jsonConfiguration = File.ReadAllText(@"D:\Ajay\Projects\Self\Git\Acubec.Payments.ISO8583Parser\Acubec.Payments.ISO8583Parser.Test\RupaySchema.json");
        JsonSerializerOptions options = new();
        options.PropertyNameCaseInsensitive = true;
        var configuration = System.Text.Json.JsonSerializer.Deserialize<SchemaConfiguration>(jsonConfiguration, options);


        var parser = new ISO8583MessageParser(_serviceProvider);
        var strMessageBytes = "30323030F23B66810AE08208000000000100000031363636373738383030303030303030303431323334353630303030303036303030303031323231313432373033303030303031303932373033313232313132323131323231353939393335363930313030313030303637323030303133333535303930303030303130305445535431323334544553543132333435363738393031525550415920544553542053494D554C41544F522020204D554D424149202020202020204D48494E333536313633394630323030303946303330303039463236303030303832303034373830303946333630303035463334303030394632373030323830394633343030363146303030323946313030313630313035413030303033303030303030394633333030364530453038303946314130303039463335303032323230393530313030303030303438303030354632413030303039413030303039433030323132394633373030303034313237354134363356523331313030303435323031324156454E55452053555045524D41524420494E44303739303038303031353030393035303132333435363738393031323334353637383930313233343536373839304173646667686A6B6C706F69757974726577713130313330303236343031343030323235";
        //var strMessageBytes =   "30323030F23B66810AE08208800000000100000031363637373838303030303030303030343131323334353630303030303036303030303031323231313432373033303030303031303932373033313232313132323131323231353939393335363930313030313030303632303030313333333535303930303030303130305445535431323334544553543132333435363738393031525550415920544553542053494D554C41544F522020204D554D424149202020202020204D48494E333536313633394630323030303946303330303039463236303030303832303034373830303946333630303035463334303030394632373030323830394633343030363146303030323946313030313630313035413030303033303030303030394633333030364530453038303946314130303039463335303032323230393530313030303030303438303030354632413030303039413030303039433030323132394633373030303034313237354134363356523331313030303435323031324156454E55452053555045524D41524420494E44303739303038303031353030393035303132333435363738393031323334353637383930313233343536373839304173646667686A6B6C706F69757974726577713130313330303236343031343030323235";

        var messageBytes = ByteHelper.GetBytesFromHexString(strMessageBytes);
        var isoMessage = parser.Parse(configuration, messageBytes, _serviceProvider);

        // Act
        var result = parser.ToBytes(isoMessage,configuration.SchemaEncoding);
        var resultString = ByteHelper.GetHexRepresentation(result);
        // Assert
        Assert.NotNull(result);
        Assert.Equal(strMessageBytes, resultString);
    }
}
